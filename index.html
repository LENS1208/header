<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FX取引分析ツール - 修正版ヘッダー（統率デモ組込版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg-primary:#000000;
      --bg-secondary:#181818;
      --bg-tertiary:#232323;
      --border-color:#373737;
      --positive-color:#00c8ff; /* 既定のコーポレート色（必要なら残す） */
      --negative-color:#ff3200;
      --text-main:#e0e0e0;
      --text-sub:#aaa;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Segoe UI','Hiragino Sans','Yu Gothic UI',system-ui,sans-serif;
      background:var(--bg-primary);
      color:var(--text-main);
      min-height:100vh;
    }

    /* ヘッダー */
    .header-container{
      background:#000; /* 黒 */
      border-bottom:1px solid var(--border-color);
      box-shadow:0 4px 20px rgba(0,0,0,.5);
    }
    .header-main{padding:15px 20px;display:flex;align-items:center;justify-content:space-between;min-height:70px;}
    .left-section{display:flex;align-items:center;}
    .logo img{display:block;width:100px;height:auto;}
    .center-section{flex:1;text-align:center;min-width:300px;}
    .main-title{font-size:20px;font-weight:700;color:var(--text-main);margin-bottom:4px;}
    .subtitle{font-size:12px;color:var(--text-sub);font-weight:400;}
    .right-section{display:flex;align-items:center;gap:15px;}

    /* アップロード（グラデーション適用） */
    .upload-wrapper{position:relative;}
    .upload-btn{
      display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;
      min-height:36px;
      background:linear-gradient(90deg,#00c8ff,#007bff); /* 水色→青 */
      color:#fff;border:none;border-radius:4px;
      font-size:13px;font-weight:600;padding:8px 16px;cursor:pointer;transition:.2s;
    }
    .upload-btn:hover{opacity:.9;transform:translateY(-1px);}
    .file-input{display:none;}
    .file-info{
      position:absolute;top:100%;left:0;background:var(--bg-tertiary);border:1px solid var(--border-color);
      border-radius:4px;padding:8px 12px;font-size:11px;color:var(--text-sub);margin-top:5px;white-space:nowrap;z-index:10;
    }

    /* デモスイッチ */
    .demo-section{display:flex;align-items:center;gap:8px;}
    .demo-label{font-size:12px;color:var(--text-sub);white-space:nowrap;}
    .demo-buttons{display:flex;gap:4px;}
    .demo-btn{
      background:var(--bg-tertiary);color:var(--text-main);border:1px solid var(--border-color);
      border-radius:4px;font-size:12px;font-weight:600;width:28px;height:28px;
      display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;
    }
    .demo-btn:hover{background:var(--bg-secondary);border-color:var(--text-sub);transform:translateY(-1px);}
    .demo-btn.active{background:var(--positive-color);border-color:var(--positive-color);color:#fff;}

    /* フィルター帯 */
    .filters-section{padding:15px 20px;background:rgba(35,35,35,.3);border-top:1px solid var(--border-color);}
    .filters-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      row-gap:10px;          /* 縦間隔 */
      column-gap:16px;       /* 横間隔（接触防止） */
      max-width:1360px;      /* 1200px → 1360px に拡大（改行防止） */
      margin:0 auto 15px;
    }
    .filter-select{
      background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;color:var(--text-main);
      font-size:12px;padding:6px 10px;transition:.2s;width:100%;
    }
    .filter-select:focus{outline:none;border-color:var(--positive-color);box-shadow:0 0 0 2px rgba(0,200,255,.1);}
    .filter-select:hover{border-color:var(--text-sub);}
    .filter-select option{background:var(--bg-tertiary);color:var(--text-main);}

    /* ボタン行：右端寄せ＋セレクトとの間に余白（改行せず並ぶ） */
    .filter-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
      justify-self:end;  /* グリッド右端へ */
      align-self:end;
      padding-left:16px; /* 左のセレクトとの距離 */
    }
    /* 余分な列幅を取らない。span指定はしない */
    @media (min-width:900px){
      .filter-actions{ /* 右端寄せのみ維持 */ }
    }

    /* フィルター適用ボタン（グラデーション） */
    .filter-btn{
      display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;
      min-height:36px;
      background:linear-gradient(90deg,#00c8ff,#007bff); /* 水色→青 */
      color:#fff;border:none;border-radius:4px;
      font-size:12px;font-weight:600;padding:8px 14px;cursor:pointer;transition:.2s;
    }
    .filter-btn:hover{opacity:.9;transform:translateY(-1px);}

    /* リセット：テキストボタン風（高さ合わせ） */
    .filter-btn.secondary{
      background:transparent;color:var(--text-sub);
      border:1px dashed var(--border-color);
      font-weight:500;padding:8px 14px;min-height:36px;white-space:nowrap;
    }
    .filter-btn.secondary:hover{color:var(--text-main);border-style:solid;background:transparent;transform:none;opacity:1;}

    /* タブ（ブラウザ風下線） */
    .nav-tabs{display:flex;justify-content:center;border-bottom:1px solid var(--border-color);margin-top:10px;}
    .tab{
      background:none;border:none;border-bottom:3px solid transparent;color:var(--text-sub);
      font-size:14px;font-weight:500;padding:10px 16px;cursor:pointer;transition:all .2s ease;
    }
    .tab:hover{color:var(--text-main);border-bottom:3px solid var(--text-sub);}
    .tab.active{color:var(--positive-color);border-bottom:3px solid var(--positive-color);font-weight:600;}

    /* 期間カスタム */
    .date-input-group{display:none;grid-column:span 2;gap:8px;}
    .date-input-group.active{display:flex;}
    .date-input{
      background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;color:var(--text-main);
      font-size:12px;padding:6px 8px;flex:1;
    }
    .date-input:focus{outline:none;border-color:var(--positive-color);}

    /* レスポンシブ */
    @media (max-width:768px){
      .header-main{flex-direction:column;gap:15px;padding:15px;}
      .left-section{width:100%;justify-content:center;}
      .center-section{order:1;}
      .right-section{order:2;flex-wrap:wrap;justify-content:center;gap:10px;}
      .demo-section{flex-direction:column;gap:5px;}
      .filters-grid{grid-template-columns:1fr;gap:8px;}
      .nav-tabs{gap:6px;}
      .tab{padding:8px 12px;font-size:12px;}
      .main-title{font-size:18px;}
      .upload-btn{font-size:11px;padding:6px 12px;}
      .filter-actions{justify-content:center;padding-left:0;} /* モバイルは中央寄せ＆余白なし */
    }

    /* DEMOバッジ（非表示のまま） */
    #demoBadge{
      position:fixed;top:10px;right:10px;padding:6px 10px;border-radius:999px;background:#222;color:#fff;
      font:12px/1 system-ui;border:1px solid #444;z-index:9999;opacity:.9;display:none!important;
    }
  </style>
</head>
<body>
  <div id="demoBadge" hidden>DEMO</div>

  <header class="header-container">
    <div class="header-main">
      <div class="left-section">
        <div class="logo">
          <img src="algo-logo-web-b.png" alt="FX Analysis Logo" width="100" height="66" />
        </div>
      </div>

      <div class="center-section">
        <h1 class="main-title">FX取引分析ダッシュボード</h1>
        <p class="subtitle">パフォーマンス分析とリスク管理の統合プラットフォーム</p>
      </div>

      <div class="right-section">
        <div class="upload-wrapper">
          <input type="file" id="fileInput" class="file-input" accept=".csv,.json" />
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">取引ファイルをアップロード</button>
          <div class="file-info" id="fileInfo" style="display:none;">ファイルが選択されていません</div>
        </div>
        <div class="demo-section">
          <span class="demo-label">デモデータ</span>
          <div class="demo-buttons">
            <button class="demo-btn" id="demoA" data-trader="excellent">A</button>
            <button class="demo-btn" id="demoB" data-trader="average">B</button>
            <button class="demo-btn" id="demoC" data-trader="poor">C</button>
          </div>
        </div>
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-grid">
        <select class="filter-select" id="currencyFilter">
          <option value="all">すべての通貨ペア</option>
          <optgroup label="メジャーペア">
            <option value="USDJPY">USD/JPY</option><option value="EURUSD">EUR/USD</option>
            <option value="GBPUSD">GBP/USD</option><option value="USDCHF">USD/CHF</option>
            <option value="AUDUSD">AUD/USD</option><option value="NZDUSD">NZD/USD</option>
            <option value="USDCAD">USD/CAD</option>
          </optgroup>
          <optgroup label="クロス円">
            <option value="EURJPY">EUR/JPY</option><option value="GBPJPY">GBP/JPY</option>
            <option value="AUDJPY">AUD/JPY</option><option value="CHFJPY">CHF/JPY</option>
            <option value="CADJPY">CAD/JPY</option><option value="NZDJPY">NZD/JPY</option>
          </optgroup>
          <optgroup label="その他">
            <option value="EURGBP">EUR/GBP</option><option value="EURAUD">EUR/AUD</option>
            <option value="GBPAUD">GBP/AUD</option><option value="AUDNZD">AUD/NZD</option>
          </optgroup>
        </select>

        <select class="filter-select" id="timeFilter">
          <option value="all">すべての時間</option>
          <option value="asia">アジア時間 (5:00-15:59)</option>
          <option value="london">ロンドン時間 (16:00-21:59)</option>
          <option value="ny">NY時間 (22:00-1:59)</option>
          <option value="quiet">閑散時間 (2:00-4:59)</option>
        </select>

        <select class="filter-select" id="dayFilter">
          <option value="all">すべての曜日</option>
          <option value="weekdays">平日のみ</option>
          <option value="weekend">週末のみ</option>
          <optgroup label="個別選択">
            <option value="monday">月曜日</option><option value="tuesday">火曜日</option>
            <option value="wednesday">水曜日</option><option value="thursday">木曜日</option>
            <option value="friday">金曜日</option><option value="saturday">土曜日</option>
            <option value="sunday">日曜日</option>
          </optgroup>
        </select>

        <select class="filter-select" id="periodFilter">
          <option value="all">すべての期間</option>
          <option value="30days">直近30日</option>
          <option value="90days">直近90日</option>
          <option value="6months">直近6ヶ月</option>
          <option value="1year">直近1年</option>
          <option value="custom">カスタム期間</option>
        </select>

        <select class="filter-select" id="positionFilter">
          <option value="all">すべてのポジション</option>
          <option value="long">ロング（買い）のみ</option>
          <option value="short">ショート（売り）のみ</option>
        </select>

        <select class="filter-select" id="performanceFilter">
          <option value="all">すべての取引</option>
          <option value="profit">利益取引のみ</option>
          <option value="loss">損失取引のみ</option>
        </select>

        <div class="date-input-group" id="customDateGroup">
          <input type="date" class="date-input" id="startDate" />
          <input type="date" class="date-input" id="endDate" />
        </div>

        <!-- 右端に吸着するボタン群（同じ行に並ぶ／幅が狭いときは次段へ） -->
        <div class="filter-actions">
          <button class="filter-btn" id="applyFilters">フィルター適用</button>
          <button class="filter-btn secondary" id="resetFilters">リセット</button>
        </div>
      </div>

      <div class="nav-tabs">
        <div class="tab active" data-section="summary">サマリー</div>
        <div class="tab" data-section="exit-efficiency">Exit効率</div>
        <div class="tab" data-section="holding-time">保有時間</div>
        <div class="tab" data-section="risk-stability">リスク安定性</div>
        <div class="tab" data-section="categories">分類別</div>
        <div class="tab" data-section="score">スコア</div>
      </div>
    </div>
  </header>

  <script>
    // ===== デモデータ =====
    const DEMO_TRADERS={
      excellent:{name:"優秀なトレーダー",description:"勝率75%、高い期待値を持つトレーダーのデータ",
        kpi:{totalTrades:150,winRate:75.2,totalProfit:320000,avgProfit:12800,avgLoss:-4200,expectedValue:2133,profitFactor:3.05},
        delta:{pf:0.25,ev:1200,wr:-2.1},
        pareto:{top:[45000,38000,32000,28000,25000],bottom:[-8000,-6500,-5200,-4800,-4100]},
        streaks:{win:[8,6,5,4,3],lose:[2,2,1,1,1]}},
      average:{name:"平均的なトレーダー",description:"勝率55%、標準的なパフォーマンスのトレーダーデータ",
        kpi:{totalTrades:120,winRate:55.8,totalProfit:45000,avgProfit:8500,avgLoss:-6200,expectedValue:375,profitFactor:1.18},
        delta:{pf:-0.15,ev:-800,wr:1.8},
        pareto:{top:[25000,18000,15000,12000,10500],bottom:[-15000,-12000,-9500,-8200,-7100]},
        streaks:{win:[5,4,3,3,2],lose:[4,3,3,2,2]}},
      poor:{name:"改善が必要なトレーダー",description:"勝率38%、損失超過のトレーダーデータ",
        kpi:{totalTrades:95,winRate:38.9,totalProfit:-85000,avgProfit:6200,avgLoss:-8900,expectedValue:-895,profitFactor:0.65},
        delta:{pf:-0.45,ev:-2100,wr:-8.3},
        pareto:{top:[18000,12000,9500,8200,7100],bottom:[-25000,-18000,-15000,-12000,-10500]},
        streaks:{win:[3,2,2,1,1],lose:[7,5,4,4,3]}}
    };

    const CALCULATIONS={
      getWinTrades:(d)=>Math.round(d.kpi.totalTrades*d.kpi.winRate/100),
      getLossTrades:(d)=>Math.round(d.kpi.totalTrades*(100-d.kpi.winRate)/100),
      getTotalWinAmount:(d)=>Math.round(CALCULATIONS.getWinTrades(d)*d.kpi.avgProfit),
      getTotalLossAmount:(d)=>Math.round(Math.abs(CALCULATIONS.getLossTrades(d)*d.kpi.avgLoss)),
      getMaxWin:(d)=>d.pareto.top[0],
      getMinWin:(d)=>d.pareto.top[d.pareto.top.length-1],
      getMaxLoss:(d)=>Math.abs(d.pareto.bottom[0]),
      getMinLoss:(d)=>Math.abs(d.pareto.bottom[d.pareto.bottom.length-1]
    )};

    function generateRealisticCumulativeCurve(tradeCount,finalProfit,winRate){
      const result=[0];let cur=0;
      for(let i=1;i<tradeCount;i++){
        const isWin=Math.random()<winRate;
        if(isWin){
          const avgWin=finalProfit>0?Math.abs(finalProfit)/(tradeCount*winRate)*1.2:8000+Math.random()*12000;
          cur+=avgWin*(0.7+Math.random()*0.6);
        }else{
          const avgLoss=finalProfit>0?Math.abs(finalProfit)/(tradeCount*(1-winRate))*0.8:4000+Math.random()*8000;
          cur-=avgLoss*(0.7+Math.random()*0.6);
        }
        result.push(Math.round(cur));
      }
      const adjust=finalProfit-result[result.length-1];
      const per=adjust/(tradeCount*0.3);
      const start=Math.floor(tradeCount*0.7);
      for(let i=start;i<tradeCount;i++) result[i]+=Math.round(per*(i-start));
      return result;
    }

    const CATEGORY_DATA={
      getBasicMetrics:(key)=>{
        const t=DEMO_TRADERS[key];
        return {...t.kpi,delta:t.delta,
          winTrades:CALCULATIONS.getWinTrades(t),
          lossTrades:CALCULATIONS.getLossTrades(t),
          totalWinAmount:CALCULATIONS.getTotalWinAmount(t),
          totalLossAmount:CALCULATIONS.getTotalLossAmount(t),
          maxWin:CALCULATIONS.getMaxWin(t),
          minWin:CALCULATIONS.getMinWin(t),
          maxLoss:CALCULATIONS.getMaxLoss(t),
          minLoss:CALCULATIONS.getMinLoss(t)};
      },
      getRiskMetrics:(key)=>({
        maxDrawdown:DEMO_TRADERS[key].kpi.totalProfit*-0.15,
        volatility:key==='excellent'?0.12:key==='average'?0.28:0.45,
        sharpeRatio:key==='excellent'?2.15:key==='average'?0.85:-0.32
      }),
      getTimeAnalysis:(key)=>({
        excellent:{bestDay:"火曜日",worstDay:"金曜日"},
        average:{bestDay:"水曜日",worstDay:"月曜日"},
        poor:{bestDay:"木曜日",worstDay:"月曜日"}
      })[key],
      getSymbolAnalysis:(key)=>{
        const symbols=['USDJPY','EURUSD','GBPUSD','EURJPY','GBPJPY'];
        return symbols.map(symbol=>({symbol,performance:key==='excellent'?'good':key==='average'?'neutral':'poor'}));
      }
    };

    // 単一情報源ストア
    const AppStore={
      cfg:{mode:'demo',trader:'excellent',version:'v1',show_demo_badge:true},
      data:null,filters:{},listeners:new Set(),
      subscribe(fn){this.listeners.add(fn);return()=>this.listeners.delete(fn);},
      notify(){for(const fn of this.listeners) fn({cfg:this.cfg,data:this.data,filters:this.filters});},
      setConfig(part){Object.assign(this.cfg,part);this.persistCfg();this.notify();},
      setData(d){this.data=d;this.notify();},
      setFilters(f){this.filters=f;this.notify();},
      persistCfg(){try{localStorage.setItem('demo_cfg',JSON.stringify(this.cfg));}catch{}},
      restoreCfg(){
        try{const saved=JSON.parse(localStorage.getItem('demo_cfg')||'null');if(saved) this.cfg={...this.cfg,...saved};}catch{}
        const q=new URLSearchParams(location.search);
        if(q.get('trader')) this.cfg.trader=q.get('trader');
        if(q.get('mode')) this.cfg.mode=q.get('mode');
      }
    };
    window.AppStore=AppStore;

    function dispatch(name,detail){document.dispatchEvent(new CustomEvent(name,{detail}));}

    function buildUnifiedDemo(traderKey){
      const t=DEMO_TRADERS[traderKey]||DEMO_TRADERS.excellent;
      const basic=CATEGORY_DATA.getBasicMetrics(traderKey);
      const risk=CATEGORY_DATA.getRiskMetrics(traderKey);
      const time=CATEGORY_DATA.getTimeAnalysis(traderKey);
      const sym=CATEGORY_DATA.getSymbolAnalysis(traderKey);
      const curve=generateRealisticCumulativeCurve(t.kpi.totalTrades,t.kpi.totalProfit,t.kpi.winRate/100);
      return {key:traderKey,meta:{name:t.name,description:t.description,version:AppStore.cfg.version},
        kpi:basic,risk,time,symbols:sym,streaks:t.streaks,pareto:t.pareto,equityCurve:curve};
    }

    function renderHeaderSummary(_d){/* いまは未使用 */}

    function updateDemoBadge(){
      const b=document.getElementById('demoBadge');
      b.hidden=!(AppStore.cfg.mode==='demo'&&AppStore.cfg.show_demo_badge);
      if(!b.hidden) b.textContent=`DEMO • ${AppStore.cfg.trader} • ${AppStore.cfg.version}`;
    }

    function selectDemoButton(trader){
      document.querySelectorAll('.demo-btn').forEach(btn=>{
        btn.classList.toggle('active',btn.dataset.trader===trader);
      });
    }

    function activateTrader(traderKey){
      AppStore.setConfig({trader:traderKey});
      const unified=buildUnifiedDemo(traderKey);
      AppStore.setData(unified);
      renderHeaderSummary(unified);
      updateDemoBadge();
      selectDemoButton(traderKey);
      dispatch('demoDataReady',unified);
    }

    // 初期化
    function initializeDemoUI(){
      document.querySelectorAll('.demo-btn').forEach(btn=>{
        btn.addEventListener('click',()=>activateTrader(btn.dataset.trader));
      });
    }
    function initializeFileUpload(){
      const input=document.getElementById('fileInput');
      const info=document.getElementById('fileInfo');
      input.addEventListener('change',(ev)=>{
        const file=ev.target.files[0]; if(!file) return;
        info.style.display='block';
        info.textContent=`${file.name} (${(file.size/1024).toFixed(1)} KB)`;
        dispatch('fileUploaded',file);
      });
    }
    function initializeFilters(){
      const periodFilter=document.getElementById('periodFilter');
      const customDateGroup=document.getElementById('customDateGroup');
      periodFilter.addEventListener('change',function(){
        if(this.value==='custom') customDateGroup.classList.add('active');
        else customDateGroup.classList.remove('active');
      });
      document.getElementById('applyFilters').addEventListener('click',()=>{
        const f=getFilterValues(); AppStore.setFilters(f); dispatch('filtersChanged',f);
      });
      document.getElementById('resetFilters').addEventListener('click',()=>{
        resetAllFilters(); const f=getFilterValues(); AppStore.setFilters(f); dispatch('filtersChanged',f);
      });
    }
    function getFilterValues(){
      return{
        currency:document.getElementById('currencyFilter').value,
        time:document.getElementById('timeFilter').value,
        day:document.getElementById('dayFilter').value,
        period:document.getElementById('periodFilter').value,
        startDate:document.getElementById('startDate').value,
        endDate:document.getElementById('endDate').value,
        performance:document.getElementById('performanceFilter').value,
        position:document.getElementById('positionFilter').value
      };
    }
    function resetAllFilters(){
      document.getElementById('currencyFilter').value='all';
      document.getElementById('timeFilter').value='all';
      document.getElementById('dayFilter').value='all';
      document.getElementById('periodFilter').value='all';
      document.getElementById('startDate').value='';
      document.getElementById('endDate').value='';
      document.getElementById('performanceFilter').value='all';
      document.getElementById('positionFilter').value='all';
      document.getElementById('customDateGroup').classList.remove('active');
    }
    function initializeTabs(){
      const tabs=document.querySelectorAll('.tab');
      tabs.forEach(tab=>{
        tab.addEventListener('click',()=>{
          tabs.forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          dispatch('tabChanged',{section:tab.dataset.section});
        });
      });
    }

    window.addEventListener('DOMContentLoaded',()=>{
      initializeDemoUI();
      initializeFileUpload();
      initializeFilters();
      initializeTabs();
      AppStore.restoreCfg();
      updateDemoBadge();
      selectDemoButton(AppStore.cfg.trader);
      const initData=buildUnifiedDemo(AppStore.cfg.trader);
      AppStore.setData(initData);
      renderHeaderSummary(initData);
      dispatch('demoDataReady',initData);
    });
  </script>
</body>
</html>
